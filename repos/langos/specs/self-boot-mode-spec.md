# LangOS 自举模式需求规格

## 1. 背景与目标
- 目的：在治理/改协议时，把 `langos/` 视为被开发的仓库、`langos-docs/` 视为业务文档库，按需求→方案→编码→评审流程自我迭代。
- 目标：提供清晰入口与确认闸门，避免随意热改运行时。

## 2. 范围与非范围
- 范围：新增/修改运行时协议、路由、规范文档（`runtime/*`、`meta/` 相关）。
- 非范围：外部业务项目开发、非本仓代码改动。

## 3. 触发与入口
- 触发条件：用户选择治理/自举模式，业务文档库指定为 `langos-docs/`，代码仓为 `langos/`。
- 入口提示：启动时必须复述自举 SOP，指向本规格；未完成文档目录确认/需求/方案前不写文件。
- 配置来源：启动时读取仓根 `.langos-local.yaml`（优先）或 `.langos.yaml` 的 `doc_root`（业务文档相对目录）；未读取到配置或路径不存在时必须阻断，要求用户显式指定后才能继续。

## 4. 输入
- 用户意图：要改的协议/规范/路由或要新增的能力。
- 现有资料：`langos/runtime/*`、`langos-docs/repos/langos/*`（governance、既有 specs）。
- 本地配置：`.langos-local.yaml` / `.langos.yaml` 中的 `doc_root`；缺失时需向用户索取。
- 约束：全程中文；写入前需确认；无专门工具依赖（不强制模拟协议）。

## 5. 输出
- 需求规格文档（本文件或新增 spec）。
- 如有改动：更新后的协议/文档文件、同步的 `runtime/protocols/index.yaml`（如涉及路由）。
- 过程结论：确认点、未决项记录。

## 6. 自举流程（需求→方案→编码→评审）
0) 启动与上下文校验：
   - 启动提示需引用本 spec，提醒处于治理模式且有热改风险。
   - 读取 `.langos-local.yaml`（优先）或 `.langos.yaml` 的 `doc_root`；若未找到或路径不存在，要求用户明确指定后才能进入后续步骤。
   - 记录当前代码仓（`langos/`）与文档仓（默认为配置的 `doc_root`，示例 `langos-docs/`），未确认前不得改文件。
1) 需求梳理：用 `add_requirement` 或等效步骤形成结构化 spec，确认后进入方案。
2) 方案设计：说明变更范围、接口/路由影响、风险与防御；确认后才动文件。
3) 编码实现：写入前复述预期变更与影响；直接编辑协议/文档，必要时做手动对话模拟，但不强制 `simulate_protocol`。
4) 评审收尾：对照 spec/方案检查闭环、确认点覆盖、风险缓解、文档/索引同步；确认结论后收尾。

## 7. 确认闸门与防御
- 必需确认：文档目录已通过配置或用户输入确定；需求确认；方案确认；写入前确认；评审结论确认。
- 安全防御：启动时提醒热改风险；涉及路由/index 变更时复述潜在断流影响；未指定/不存在的文档目录下禁止写入。
- 记录：关键假设、确认状态在对话或文档中留痕。

## 8. 风险与缓解
- 热插拔风险：通过确认序列和小步修改降低；必要时人工对话模拟关键分支。
- 覆盖缺失：缺目标协议时先补 spec，再按自举流程设计修改。
- 信息不足：缺上下文先查 `governance.md`/相关 spec 或向用户提问。

## 9. 验收标准
- 治理模式下的启动提示明确引用本规格，并在进入流程前完成文档目录确认（读取 `.langos-local.yaml`/`.langos.yaml` 的 `doc_root` 或用户显式指定）。
- 协议/规范改动前有已确认的需求与方案。
- 路由/协议改动后索引与文档同步，无未确认高风险项。

## 10. 说明
- 不再强制使用 `simulate_protocol`；按需人工模拟或复盘即可。
- 不依赖 `add_protocol` 协议，新增协议由自举流程直接编辑文件并同步索引。
